#jinja2: trim_blocks: "true", lstrip_blocks: "false"
{% for user in users %}
    {% for domain, document_root in user.domains_and_document_roots.items() %}
<VirtualHost {{ inventory_hostname }}:8001>
    AddExternalAuth       pwauth /usr/sbin/pwauth
    CustomLog             ${APACHE_LOG_DIR}/access.log combined
    DocumentRoot          "/var/netenberg/fantastico_f3/sources"
    ErrorLog              ${APACHE_LOG_DIR}/error.log
    ServerAdmin           webmaster@localhost
    ServerName            {{ domain }}
    SetEnv                CONTROL_PANEL "Standalone"
    SetEnv                SECTION "administrators"
    SetExternalAuthMethod pwauth pipe
    SuexecUserGroup       root root
    <Directory "/var/netenberg/fantastico_f3/sources">
        AuthBasicProvider external
        AuthExternal      pwauth
        AuthName          "Fantastico F3"
        AuthType          Basic
        Require           user root
    </Directory>
</VirtualHost>

<VirtualHost {{ inventory_hostname }}:8002>
    AddExternalAuth       pwauth /usr/sbin/pwauth
    CustomLog             ${APACHE_LOG_DIR}/access.log combined
    DocumentRoot          "/var/netenberg/fantastico_f3/sources"
    ErrorLog              ${APACHE_LOG_DIR}/error.log
    ServerAdmin           webmaster@localhost
    ServerName            {{ domain }}
    SetEnv                CONTROL_PANEL "Standalone"
    SetEnv                SECTION "visitors"
    SetExternalAuthMethod pwauth pipe
    SuexecUserGroup       {{ user.username }} {{ user.username }}

    <Directory "/var/netenberg/fantastico_f3/sources">
        AuthBasicProvider external
        AuthExternal      pwauth
        AuthName          "Fantastico F3"
        AuthType          Basic
        Require           valid-user
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    CustomLog       ${APACHE_LOG_DIR}/access.log combined
    DocumentRoot    "{{ document_root }}"
    ErrorLog        ${APACHE_LOG_DIR}/error.log
    ServerAdmin     webmaster@localhost
    ServerName      {{ domain }}
    SuexecUserGroup {{ user.username }} {{ user.username }}
</VirtualHost>
    {% endfor %}
{% endfor %}
